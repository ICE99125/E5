<!DOCTYPE html>
<html lang="zh-cn">

<head>
    <meta charset="UTF-8">
    <link rel="Shortcut Icon" href="{{ url_for('static', filename='favicon.ico') }}" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <link rel="styleSheet" href="{{ url_for('static', filename='style.css') }}">
    <title>Ëé∑ÂèñÂà∑Êñ∞‰ª§Áâå</title>
</head>

<body class="flex-center">
    <table id="table">
        <tr>
            <td>
                <label id="label" for="ClientID">Â∫îÁî®ID</label>
            </td>
            <td>
                <input id="ClientID" />
            </td>
        </tr>
        <tr>
            <td>
                <label id="label" for="ClientSecret">Â∫îÁî®ÂØÜÈí•</label>
            </td>
            <td>
                <input id="ClientSecret" />
            </td>
        </tr>
        <tr>
            <td>
                <label id="ScopeAndTokenLabel" for="ScopeAndToken"></label>
            </td>
            <td><textarea row="4" id="ScopeAndToken"></textarea>
            </td>
        </tr>
    </table>
    <button id="btn"></button>
    <script>
        // Ê†πÊçÆ ID Ëé∑Âèñ DOM
        function DomByID(ID) {
            return document.getElementById(ID);
        }

        function getCode(REDIRECT_URI, CLIENT_ID, SCOPE_VALUE, CLIENT_SECRET) {
            if (CLIENT_ID && CLIENT_SECRET) {
                // Ëé∑ÂèñÊéàÊùÉÁ†ÅÂú∞ÂùÄ
                const AUTHORIZE = 'https://login.microsoftonline.com/common/oauth2/v2.0/authorize';
                // Â∞ÜÂ∫îÁî® ID ÂíåÂØÜÈí•Â≠òÂÖ•ÁºìÂ≠ò
                localStorage.setItem('CLIENT_ID', CLIENT_ID);
                localStorage.setItem('CLIENT_SECRET', CLIENT_SECRET);
                // Ë∑≥ËΩ¨Ëé∑ÂèñÊéàÊùÉÁ†Å
                location.href =
                    `${AUTHORIZE}?client_id=${CLIENT_ID}&scope=${SCOPE_VALUE}&response_type=code&redirect_uri=${REDIRECT_URI}`
            } else {
                alert("ËØ∑ÂÖàÂ°´ÂÜôÂÆåÊØïÂêéÂÜçÊèê‰∫§Âì¶üòõ")
            }
        }

        function getUrlParams(url) {
            // ‰ªé url ‰∏≠Êà™Âèñ ‚Äú?‚Äù ÂêéÁöÑÂèÇÊï∞ÂΩ¢Êàê json
            const reg = /([^?&=]+)=([^?&=]*)/g;
            let obj = {};
            url.replace(reg, function (rs, $1, $2) {
                let name = decodeURIComponent($1);
                let val = decodeURIComponent($2);
                obj[name] = val;
                return rs;
            });
            return obj;
        }

        // Âêë flask ÊúçÂä°Âô®ËØ∑Ê±Ç
        function getToken() {
            const xhr = new XMLHttpRequest();

            xhr.open("POST", '../getToken', false);
            xhr.setRequestHeader('content-type', 'application/json');
            const data = {
                "code": CODE,
                "client_id": localStorage.getItem('CLIENT_ID'),
                "client_secret": localStorage.getItem('CLIENT_SECRET'),
                "redirect_uri": REDIRECT_URI, // ÈáçÂÆöÂêëÂú∞ÂùÄ
                "grant_type": "authorization_code"
            }
            xhr.send(JSON.stringify(data));
            SCOPE_AND_TOKEN.value = xhr.responseText; // Â∞ÜÊî∂Âà∞ÁöÑÊï∞ÊçÆÊ∏≤ÊüìÂà∞ÊñáÊú¨Ê°Ü‰∏ä
        }

        function copyToClipboard(value) {
            // ÂàõÂª∫‰∏Ä‰∏™ÊñáÊú¨Ê°Ü
            const el = document.createElement("textarea");
            el.value = value;
            // Ê†πÊçÆ DOM Ê∑ªÂä†Â±ûÊÄß
            Object.assign(el.style, {
                position: "absolute",
                left: "-999px"
            });
            // ÊèíÂÖ•ÊñáÊú¨Ê°Ü
            document.body.appendChild(el);
            el.select(); // ÈÄâÊã©Ëøô‰∏™ÈöêËóèÁöÑÊñáÊú¨Ê°Ü
            document.execCommand("Copy");
            el.parentNode.removeChild(el); // Âà†Èô§ÊñáÊú¨Ê°Ü
            alert("Â§çÂà∂ÊàêÂäü")
        }

        // Â§çÂà∂ Token
        function copyToken(SCOPE_AND_TOKEN) {
            copyToClipboard(SCOPE_AND_TOKEN);
        }

        const CODE = getUrlParams(window.location.search).code; // Ëé∑Âèñ url ÈáåÁöÑÂèÇÊï∞
        const BTN = DomByID("btn");
        const CLIENT_ID = DomByID('ClientID');
        const CLIENT_SECRET = DomByID("ClientSecret");
        const SCOPE_AND_TOKEN = DomByID('ScopeAndToken');
        const REDIRECT_URI = 'http://localhost:5000/';
        const SCOPE_AND_TOKEN_LABEL = DomByID("ScopeAndTokenLabel");

        if (!CODE) {
            // ‰ΩúÁî®Âüü(scope)
            // ÂøÖÈ°ªËØ∑Ê±Ç offline_access Âê¶ÂàôÊ≤°Êúâ refresh_token
            const SCOPE_VALUE = "offline_access Files.Read.All Files.ReadWrite.All Sites.Read.All Sites.ReadWrite.All User.Read.All User.ReadWrite.All Directory.Read.All Directory.ReadWrite.All Mail.Read Mail.ReadWrite MailboxSettings.Read MailboxSettings.ReadWrite";
            SCOPE_AND_TOKEN.value = SCOPE_VALUE; // ÁªôÁî®Êà∑Â±ïÁ§∫ÈªòËÆ§ÁöÑ‰ΩúÁî®Âüü
            BTN.innerHTML = 'Êèê‰∫§'
            SCOPE_AND_TOKEN_LABEL.innerHTML = '‰ΩúÁî®Âüü'
            // Áªô button ÁªëÂÆöËé∑ÂèñÊéàÊùÉÁ†Å‰∫ã‰ª∂
            BTN.addEventListener('click', ()=>{
                getCode(REDIRECT_URI, CLIENT_ID.value, SCOPE_VALUE, CLIENT_SECRET.value);
            });
        } else {
            BTN.innerHTML = 'Â§çÂà∂';
            SCOPE_AND_TOKEN_LABEL.innerHTML = 'Âà∑Êñ∞‰ª§Áâå';
            CLIENT_ID.value = localStorage.getItem("CLIENT_ID");
            CLIENT_SECRET.value = localStorage.getItem("CLIENT_SECRET")
            getToken();
            // Áªô button ÁªëÂÆöËé∑ÂèñÊéàÊùÉÁ†Å‰∫ã‰ª∂
            BTN.addEventListener('click', ()=> {
                copyToken(SCOPE_AND_TOKEN.value);
            });
        }
    </script>
</body>

</html>